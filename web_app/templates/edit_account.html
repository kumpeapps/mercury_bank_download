{% extends "base.html" %}

{% block title %}Edit Account - {{ app_name }}{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2"><i class="fas fa-edit me-2"></i>Edit Account</h1>
    <a href="{{ url_for('accounts') }}" class="btn btn-outline-secondary">
        <i class="fas fa-arrow-left me-2"></i>Back to Accounts
    </a>
</div>

<div class="row justify-content-center">
    <div class="col-md-8 col-lg-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-university me-2"></i>Account Details</h5>
            </div>
            <div class="card-body">
                <!-- Account Info -->
                <div class="mb-4">
                    <h6 class="text-muted">Account Information</h6>
                    <p class="mb-1"><strong>Name:</strong> {{ account.name }}</p>
                    <p class="mb-1"><strong>Type:</strong> {{ account.account_type or 'Unknown' }}</p>
                    <p class="mb-1"><strong>Balance:</strong> ${{ "%.2f"|format(account.balance or 0) }}</p>
                    <p class="mb-1"><strong>Mercury Account:</strong> {{ mercury_account.name }}</p>
                </div>

                <hr>

                <!-- Account Information (Read-Only) -->
                {% if account.nickname %}
                <div class="mb-3">
                    <label class="form-label">Account Nickname</label>
                    <div class="form-control-plaintext bg-light p-2 rounded border">
                        {{ account.nickname }}
                    </div>
                    <div class="form-text text-muted">
                        <i class="fas fa-info-circle"></i>
                        This nickname is set by Mercury Bank and cannot be modified.
                    </div>
                </div>
                {% endif %}

                <!-- Edit Form -->
                <form method="POST">

                    <hr>

                    <!-- Receipt Requirements Section -->
                    <div class="mb-4">
                        <h6 class="text-muted">Receipt Requirements</h6>
                        <p class="form-text mb-3">
                            <i class="fas fa-info-circle me-1"></i>
                            Set separate receipt requirements for deposits (incoming money) and charges (outgoing money).
                        </p>
                        
                        <!-- Deposits Receipt Requirements -->
                        <div class="card mb-3">
                            <div class="card-header py-2">
                                <h6 class="mb-0 text-success">
                                    <i class="fas fa-arrow-down me-2"></i>Deposits (Incoming Money)
                                </h6>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <label for="receipt_required_deposits" class="form-label">Receipt Requirement for Deposits</label>
                                    <select class="form-select" id="receipt_required_deposits" name="receipt_required_deposits">
                                        <option value="none" {{ 'selected' if account.receipt_required_deposits == 'none' else '' }}>
                                            No receipt required
                                        </option>
                                        <option value="always" {{ 'selected' if account.receipt_required_deposits == 'always' else '' }}>
                                            Always require receipt
                                        </option>
                                        <option value="threshold" {{ 'selected' if account.receipt_required_deposits == 'threshold' else '' }}>
                                            Require receipt above dollar amount
                                        </option>
                                    </select>
                                </div>

                                <div class="mb-3" id="threshold-input-deposits" style="display: {{ 'block' if account.receipt_required_deposits == 'threshold' else 'none' }};">
                                    <label for="receipt_threshold_deposits" class="form-label">Receipt Threshold for Deposits ($)</label>
                                    <input type="number" step="0.01" min="0" class="form-control" 
                                           id="receipt_threshold_deposits" name="receipt_threshold_deposits" 
                                           value="{{ account.receipt_threshold_deposits or '' }}" 
                                           placeholder="0.00">
                                    <div class="form-text">
                                        Receipts will be required for deposits at or above this amount.
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Charges Receipt Requirements -->
                        <div class="card mb-3">
                            <div class="card-header py-2">
                                <h6 class="mb-0 text-danger">
                                    <i class="fas fa-arrow-up me-2"></i>Charges (Outgoing Money)
                                </h6>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <label for="receipt_required_charges" class="form-label">Receipt Requirement for Charges</label>
                                    <select class="form-select" id="receipt_required_charges" name="receipt_required_charges">
                                        <option value="none" {{ 'selected' if account.receipt_required_charges == 'none' else '' }}>
                                            No receipt required
                                        </option>
                                        <option value="always" {{ 'selected' if account.receipt_required_charges == 'always' else '' }}>
                                            Always require receipt
                                        </option>
                                        <option value="threshold" {{ 'selected' if account.receipt_required_charges == 'threshold' else '' }}>
                                            Require receipt above dollar amount
                                        </option>
                                    </select>
                                </div>

                                <div class="mb-3" id="threshold-input-charges" style="display: {{ 'block' if account.receipt_required_charges == 'threshold' else 'none' }};">
                                    <label for="receipt_threshold_charges" class="form-label">Receipt Threshold for Charges ($)</label>
                                    <input type="number" step="0.01" min="0" class="form-control" 
                                           id="receipt_threshold_charges" name="receipt_threshold_charges" 
                                           value="{{ account.receipt_threshold_charges or '' }}" 
                                           placeholder="0.00">
                                    <div class="form-text">
                                        Receipts will be required for charges at or above this amount.
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Legacy Receipt Requirements (for backward compatibility) -->
                        <div class="card mb-3">
                            <div class="card-header py-2">
                                <h6 class="mb-0 text-muted">
                                    <i class="fas fa-sync me-2"></i>Legacy Settings (All Transactions)
                                </h6>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <label for="receipt_required" class="form-label">Receipt Requirement (Legacy)</label>
                                    <select class="form-select" id="receipt_required" name="receipt_required">
                                        <option value="none" {{ 'selected' if account.receipt_required == 'none' else '' }}>
                                            No receipt required
                                        </option>
                                        <option value="always" {{ 'selected' if account.receipt_required == 'always' else '' }}>
                                            Always require receipt
                                        </option>
                                        <option value="threshold" {{ 'selected' if account.receipt_required == 'threshold' else '' }}>
                                            Require receipt above dollar amount
                                        </option>
                                    </select>
                                    <div class="form-text">
                                        This setting is used as a fallback when separate deposit/charge settings are not configured.
                                    </div>
                                </div>

                                <div class="mb-3" id="threshold-input-legacy" style="display: {{ 'block' if account.receipt_required == 'threshold' else 'none' }};">
                                    <label for="receipt_threshold" class="form-label">Receipt Threshold (Legacy) ($)</label>
                                    <input type="number" step="0.01" min="0" class="form-control" 
                                           id="receipt_threshold" name="receipt_threshold" 
                                           value="{{ account.receipt_threshold or '' }}" 
                                           placeholder="0.00">
                                    <div class="form-text">
                                        Receipts will be required for transactions with an absolute value at or above this amount.
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <hr>

                    <!-- Report Visibility Section -->
                    <div class="mb-4">
                        <h6 class="text-muted">Report Visibility</h6>
                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="exclude_from_reports" name="exclude_from_reports" 
                                       {{ 'checked' if account.exclude_from_reports else '' }}>
                                <label class="form-check-label" for="exclude_from_reports">
                                    <strong>Exclude from Reports</strong>
                                </label>
                                <div class="form-text">
                                    When enabled, this account will be hidden from the reports page and excluded from "All Accounts" filters.
                                    You can still view transactions for this account on the accounts and transactions pages.
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <button type="submit" class="btn btn-primary w-100">
                                <i class="fas fa-save me-2"></i>Update Account
                            </button>
                        </div>
                        <div class="col-md-6">
                            <a href="{{ url_for('accounts') }}" class="btn btn-outline-secondary w-100">Cancel</a>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const receiptRequiredDeposits = document.getElementById('receipt_required_deposits');
    const thresholdInputDeposits = document.getElementById('threshold-input-deposits');
    
    const receiptRequiredCharges = document.getElementById('receipt_required_charges');
    const thresholdInputCharges = document.getElementById('threshold-input-charges');
    
    const receiptRequiredLegacy = document.getElementById('receipt_required');
    const thresholdInputLegacy = document.getElementById('threshold-input-legacy');
    
    function toggleThresholdInput(selectElement, thresholdElement) {
        if (selectElement.value === 'threshold') {
            thresholdElement.style.display = 'block';
        } else {
            thresholdElement.style.display = 'none';
        }
    }
    
    receiptRequiredDeposits.addEventListener('change', function() {
        toggleThresholdInput(receiptRequiredDeposits, thresholdInputDeposits);
    });
    
    receiptRequiredCharges.addEventListener('change', function() {
        toggleThresholdInput(receiptRequiredCharges, thresholdInputCharges);
    });
    
    receiptRequiredLegacy.addEventListener('change', function() {
        toggleThresholdInput(receiptRequiredLegacy, thresholdInputLegacy);
    });
});
</script>
{% endblock %}
